<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Scrum Update Tracker</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
      .app { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
      .sidebar { 
        border-right: 1px solid #ddd; 
        padding: 12px; 
        overflow: auto; 
        display: flex;
        flex-direction: column;
      }
      .content { padding: 16px; overflow: auto; }
      textarea { width: 100%; height: 160px; }
      .row { margin-top: 12px; display: flex; gap: 8px; }
      pre { white-space: pre-wrap; }
      .markdown-content {
        line-height: 1.6;
      }
      .markdown-content h2 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        color: #333;
        font-size: 1.2em;
        font-weight: 600;
      }
      .markdown-content ul {
        margin: 0.5em 0;
        padding-left: 1.5em;
      }
      .markdown-content li {
        margin: 0.25em 0;
      }
      .markdown-content strong {
        color: #d32f2f;
        font-weight: 600;
      }
      @media (prefers-color-scheme: dark) {
        .markdown-content h2 {
          color: #e0e0e0;
        }
        .markdown-content strong {
          color: #ff5252;
        }
      }
      .muted { color: #666; font-size: 12px; }
      .entries-container {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 12px;
      }
      .date-group {
        margin-bottom: 16px;
      }
      .date-header {
        font-weight: 600;
        font-size: 13px;
        color: #555;
        margin-bottom: 8px;
        padding: 4px 0;
        border-bottom: 1px solid #e0e0e0;
      }
      .entry-item, .summary-item {
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 8px 10px;
        margin-bottom: 4px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      .entry-item:hover, .summary-item:hover {
        background: #ebebeb;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .entry-time {
        font-size: 11px;
        color: #888;
        margin-right: 8px;
      }
      .entry-text {
        color: #333;
        display: inline;
      }
      .summary-item {
        background: #e8f5e9;
        border-color: #4caf50;
        margin-top: 8px;
      }
      .summary-item:hover {
        background: #c8e6c9;
      }
      .summary-label {
        font-weight: 600;
        color: #2e7d32;
        font-size: 11px;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .summary-preview {
        font-size: 12px;
        color: #1b5e20;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.4;
      }
      .item-actions {
        position: absolute;
        top: 4px;
        right: 4px;
        display: none;
        gap: 4px;
      }
      .entry-item:hover .item-actions,
      .summary-item:hover .item-actions {
        display: flex;
      }
      .action-btn {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 3px;
        padding: 2px 6px;
        font-size: 10px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .action-btn:hover {
        background: #f0f0f0;
      }
      .action-btn.delete {
        color: #d32f2f;
      }
      .summarize-btn {
        background: #1976d2;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        width: 100%;
        transition: background 0.2s;
      }
      .summarize-btn:hover {
        background: #1565c0;
      }
      .no-summaries {
        text-align: center;
        color: #999;
        padding: 24px;
        font-size: 13px;
      }
    </style>
    <style>
    @media (prefers-color-scheme: dark) {
      body { background: #1e1e1e; color: #e0e0e0; }
      textarea { background: #2b2b2b; color: #e0e0e0; border: 1px solid #3c3c3c; }
      button { background: #3a3a3a; color: #fff; border: 1px solid #555; }
      .muted { color: #aaaaaa; }
      .sidebar { border-right-color: #3c3c3c; }
      .date-header { 
        color: #bbb; 
        border-bottom-color: #3c3c3c;
      }
      .entry-item, .summary-item {
        background: #2b2b2b;
        border-color: #3c3c3c;
      }
      .entry-item:hover, .summary-item:hover {
        background: #333;
      }
      .entry-time { color: #888; }
      .entry-text { color: #e0e0e0; }
      .summary-item {
        background: #263238;
        border-color: #4caf50;
      }
      .summary-item:hover {
        background: #37474f;
      }
      .summary-label { color: #81c784; }
      .summary-preview { color: #a5d6a7; }
      .action-btn {
        background: #3a3a3a;
        border-color: #555;
        color: #e0e0e0;
      }
      .action-btn:hover {
        background: #444;
      }
      .summarize-btn {
        background: #2196f3;
      }
      .summarize-btn:hover {
        background: #1976d2;
      }
    }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <h4 style="margin:0 0 12px 0">Work History</h4>
        <div class="entries-container" id="entries-container">
          <div class="no-summaries" id="no-entries">No entries yet</div>
        </div>
        <button id="summarize-now-btn" class="summarize-btn">Summarize Today with AI</button>
      </aside>
      <main class="content">
        <div id="input-panel" style="display:none">
          <h3>What are you working on?</h3>
          <textarea id="entry" placeholder="Short bullet(s) â€” what you did since the last prompt, blockers, next task..."></textarea>
          <div class="row">
            <button id="save">Save</button>
            <button id="skip">Close</button>
          </div>
        </div>
        <div id="summary-panel" style="display:none">
          <h3>Daily Summary</h3>
          <div class="row">
            <button id="refresh">Re-summarize</button>
            <span class="muted">Copied to clipboard on summarize</span>
          </div>
          <div id="summary" class="markdown-content"></div>
        </div>
      </main>
    </div>

    <script>
      const $ = (s) => document.querySelector(s);
      let mode = 'input';
      let currentEditingSummary = null;
      let currentEditingEntry = null;

      function setMode(m) {
        mode = m;
        const inputPanel = $('#input-panel');
        const summaryPanel = $('#summary-panel');

        if (m === 'input') {
          inputPanel.style.display = 'block';
          summaryPanel.style.display = 'none';
        } else {
          inputPanel.style.display = 'none';
          summaryPanel.style.display = 'block';
        }
      }

      // Listen for mode changes from main process
      window.scrum.onMode(({ mode, content }) => {
        setMode(mode);
        if (mode === 'input') {
          $('#entry').value = '';
          setTimeout(() => {
            $('#entry').focus();
          }, 100);
        } else if (mode === 'summary') {
          if (content) {
            $('#summary').innerHTML = window.scrum.parseMarkdown(content);
          } else {
            $('#summary').innerHTML = '';
            window.scrum.summarizeNow().then(s => {
              $('#summary').innerHTML = s ? window.scrum.parseMarkdown(s) : '';
              loadEntries(); // Reload entries after creating new summary
            });
          }
        }
      });

      async function loadEntries() {
        const entriesByDate = await window.scrum.getEntriesByDate();
        const container = $('#entries-container');
        
        const dates = Object.keys(entriesByDate).sort((a, b) => b.localeCompare(a));
        
        if (dates.length === 0) {
          container.innerHTML = '<div class="no-summaries">No entries yet</div>';
          return;
        }

        container.innerHTML = dates.map(dateStr => {
          const data = entriesByDate[dateStr];
          const entries = data.entries || [];
          
          let html = `<div class="date-group" data-date="${dateStr}">
            <div class="date-header">${data.displayDate}</div>`;
          
          // Individual entries
          entries.forEach((entry, index) => {
            const time = new Date(entry.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            html += `
              <div class="entry-item" data-date="${dateStr}" data-index="${index}">
                <div class="item-actions">
                  <button class="action-btn edit" onclick="editEntry('${dateStr}', ${index})">Edit</button>
                  <button class="action-btn delete" onclick="deleteEntry('${dateStr}', ${index})">Delete</button>
                </div>
                <span class="entry-time">${time}</span>
                <span class="entry-text">${escapeHtml(entry.text)}</span>
              </div>`;
          });
          
          // Summary (if exists)
          if (data.summary) {
            html += `
              <div class="summary-item" data-date="${dateStr}">
                <div class="item-actions">
                  <button class="action-btn edit" onclick="editSummary('${dateStr}')">Edit</button>
                  <button class="action-btn delete" onclick="deleteSummary('${dateStr}')">Delete</button>
                </div>
                <div class="summary-label">AI Summary</div>
                <div class="summary-preview">${escapeHtml(data.summary)}</div>
              </div>`;
          }
          
          html += '</div>';
          return html;
        }).join('');

        // Add click handlers
        container.querySelectorAll('.entry-item').forEach(item => {
          item.addEventListener('click', (e) => {
            if (!e.target.classList.contains('action-btn')) {
              const dateStr = item.dataset.date;
              const index = parseInt(item.dataset.index);
              showEntry(dateStr, index);
            }
          });
        });
        
        container.querySelectorAll('.summary-item').forEach(item => {
          item.addEventListener('click', (e) => {
            if (!e.target.classList.contains('action-btn')) {
              const dateStr = item.dataset.date;
              showSummary(dateStr);
            }
          });
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      async function showEntry(dateStr, index) {
        const entriesByDate = await window.scrum.getEntriesByDate();
        const data = entriesByDate[dateStr];
        if (!data || !data.entries[index]) return;
        
        const entry = data.entries[index];
        const time = new Date(entry.ts).toLocaleTimeString();

        setMode('summary');
        $('#summary').innerHTML = `
          <h3>Entry from ${data.displayDate} at ${time}</h3>
          <p style="margin-top: 16px;">${escapeHtml(entry.text)}</p>
        `;
      }

      async function showSummary(dateStr) {
        const entriesByDate = await window.scrum.getEntriesByDate();
        const data = entriesByDate[dateStr];
        if (!data || !data.summary) return;
        
        currentEditingSummary = { date: dateStr, content: data.summary };
        setMode('summary');
        $('#summary').innerHTML = `
          <h3>AI Summary for ${data.displayDate}</h3>
          <div style="margin-top: 16px;">${window.scrum.parseMarkdown(data.summary)}</div>
        `;
      }

      async function editEntry(dateStr, index) {
        const entriesByDate = await window.scrum.getEntriesByDate();
        const data = entriesByDate[dateStr];
        if (!data || !data.entries[index]) return;
        
        const entry = data.entries[index];
        currentEditingEntry = { dateStr, index, text: entry.text };
        
        setMode('summary');
        $('#summary').innerHTML = `
          <h3>Edit Entry</h3>
          <textarea id="edit-textarea" style="width: 100%; height: 120px; margin: 16px 0;">${escapeHtml(entry.text)}</textarea>
          <div class="row">
            <button onclick="saveEditedEntry()">Save Changes</button>
            <button onclick="cancelEdit()">Cancel</button>
          </div>
        `;
        $('#edit-textarea').focus();
      }

      async function saveEditedEntry() {
        if (!currentEditingEntry) return;
        
        const newText = $('#edit-textarea').value.trim();
        if (!newText) return;
        
        const result = await window.scrum.updateEntry(currentEditingEntry.dateStr, currentEditingEntry.index, newText);
        
        if (result.success) {
          loadEntries();
          setMode('input');
        } else {
          alert('Failed to update entry: ' + (result.error || 'Unknown error'));
        }
      }

      async function editSummary(dateStr) {
        const entriesByDate = await window.scrum.getEntriesByDate();
        const data = entriesByDate[dateStr];
        if (!data || !data.summary) return;

        currentEditingSummary = { date: dateStr, content: data.summary };
        
        setMode('summary');
        $('#summary').innerHTML = `
          <h3>Edit AI Summary</h3>
          <textarea id="edit-textarea" style="width: 100%; min-height: 300px; margin: 16px 0;">${escapeHtml(data.summary)}</textarea>
          <div class="row">
            <button onclick="saveEditedSummary()">Save Changes</button>
            <button onclick="cancelEdit()">Cancel</button>
          </div>
        `;
        $('#edit-textarea').focus();
      }

      async function saveEditedSummary() {
        if (!currentEditingSummary) return;
        
        const newContent = $('#edit-textarea').value;
        const result = await window.scrum.updateSummary(currentEditingSummary.date, newContent);

        if (result.success) {
          $('#summary').innerHTML = window.scrum.parseMarkdown(newContent);
          loadEntries();
        } else {
          alert('Failed to update summary: ' + (result.error || 'Unknown error'));
        }
      }

      function cancelEdit() {
        if (currentEditingSummary) {
          $('#summary').innerHTML = window.scrum.parseMarkdown(currentEditingSummary.content);
        }
      }

      async function deleteEntry(dateStr, index) {
        if (!confirm('Delete this entry?')) return;
        
        const result = await window.scrum.deleteEntry(dateStr, index);
        if (result.success) {
          loadEntries();
        } else {
          alert('Failed to delete entry: ' + (result.error || 'Unknown error'));
        }
      }

      async function deleteSummary(dateStr) {
        if (!confirm('Delete this AI summary?')) return;
        
        const result = await window.scrum.deleteSummary(dateStr);
        if (result.success) {
          loadEntries();
          if (currentEditingSummary && currentEditingSummary.date === dateStr) {
            setMode('input');
          }
        } else {
          alert('Failed to delete summary: ' + (result.error || 'Unknown error'));
        }
      }

      $('#save').addEventListener('click', async () => {
        await window.scrum.saveEntry($('#entry').value);
        loadEntries();
      });
      $('#skip').addEventListener('click', async () => {
        await window.scrum.hideWindow();
      });
      // Enter to submit, Shift+Enter for newline
      $('#entry').addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          await window.scrum.saveEntry($('#entry').value);
          loadEntries();
        }
      });
      $('#refresh').addEventListener('click', async () => {
        const s = await window.scrum.summarizeNow();
        $('#summary').innerHTML = s ? window.scrum.parseMarkdown(s) : '';
        loadEntries();
      });

      // Summarize button in sidebar
      $('#summarize-now-btn').addEventListener('click', async () => {
        setMode('summary');
        $('#summary').innerHTML = '<p>Generating summary...</p>';
        const s = await window.scrum.summarizeNow();
        $('#summary').innerHTML = s ? window.scrum.parseMarkdown(s) : '';
        loadEntries();
      });

      // Make functions global for onclick handlers
      window.editEntry = editEntry;
      window.deleteEntry = deleteEntry;
      window.editSummary = editSummary;
      window.deleteSummary = deleteSummary;
      window.saveEditedEntry = saveEditedEntry;
      window.saveEditedSummary = saveEditedSummary;
      window.cancelEdit = cancelEdit;
      window.showEntry = showEntry;
      window.showSummary = showSummary;

      // default view when opened manually
      setMode('input');
      loadEntries();
    </script>
  </body>
  </html>

